<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FISIOPRO</title>
  <style>
    :root{
      --bg:#f4f6f9;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#5b6b82;
      --line:#e7edf4;
      --brand:#2ea08a;
      --brand2:#1f7e6c;
      --shadow:0 14px 40px rgba(2,6,23,.10);
      --shadow2:0 10px 26px rgba(2,6,23,.08);
      --radius:20px;
      --yellow:#f6d84a;
      --red:#ef4444;
      --blue:#3b82f6;
      --gray:#94a3b8;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(46,160,138,.10), transparent 55%),
                  radial-gradient(900px 500px at 85% 10%, rgba(59,130,246,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-size:19px;
      line-height:1.5;
    }
    .app{max-width:1360px;margin:0 auto;padding:18px 18px 30px}

    .topbar{
      border-radius:26px;
      padding:18px 18px;
      box-shadow: var(--shadow);
      background:
        linear-gradient(135deg, rgba(255,255,255,.16), rgba(255,255,255,0)) ,
        linear-gradient(180deg, var(--brand), var(--brand2));
      color:#fff;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      border:1px solid rgba(255,255,255,.18);
    }
    .left{display:flex;align-items:center;gap:14px;min-width:0}
    .badge{
      width:46px;height:46px;border-radius:999px;
      display:grid;place-items:center;
      background:rgba(255,255,255,.16);
      border:1px solid rgba(255,255,255,.22);
      font-weight:1000;
      letter-spacing:.8px;
      font-size:14px;
      flex:0 0 auto;
    }
    .pt-title{min-width:0}
    .pt-title h1{
      margin:0 0 2px;
      font-size:26px;
      font-weight:1000;
      letter-spacing:.2px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .pt-title p{margin:0;font-size:14px;opacity:.92}

    .top-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      border-radius:999px;
      padding:11px 14px;
      font-size:14px;
      font-weight:950;
      border:1px solid rgba(255,255,255,.28);
      background:rgba(255,255,255,.12);
      color:#fff;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease;
    }
    .pill:hover{background:rgba(255,255,255,.18);transform:translateY(-1px)}
    .pill.light{background:rgba(255,255,255,.92);color:#0b3b32;border-color:transparent}
    .pill.ghost{background:transparent;border:1px solid rgba(255,255,255,.35)}

    .layout{margin-top:14px;display:grid;grid-template-columns:420px 1fr;gap:14px;align-items:start}
    .side,.section{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow2);
      border:1px solid var(--line);
      overflow:hidden;
    }

    .side .head{
      padding:16px 16px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:linear-gradient(180deg,#fff,#fbfcfe);
    }
    .side .head h2{
      margin:0;
      font-size:18px;
      font-weight:1000;
      letter-spacing:.2px;
    }

    .btn{
      border-radius:999px;
      padding:11px 14px;
      font-size:14px;
      font-weight:1000;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      transition: transform .06s ease, box-shadow .2s ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{
      background:linear-gradient(180deg, rgba(46,160,138,.16), rgba(46,160,138,.08));
      border-color:rgba(46,160,138,.28);
      color:#0b3b32;
    }
    .btn.save{
      background:linear-gradient(180deg, var(--brand), var(--brand2));
      border-color:transparent;color:#fff;
      box-shadow:0 16px 30px rgba(46,160,138,.22);
    }
    .btn.soft{background:#fbfcfe}

    .panel{padding:14px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#fff,#fbfcfd)}
    .search{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 13px;
      font-size:15px;
      outline:none;
      background:#fbfcfe;
    }
    .search:focus{border-color:rgba(46,160,138,.45);box-shadow:0 0 0 4px rgba(46,160,138,.12);background:#fff}

    .suggest{margin-top:12px;display:flex;flex-direction:column;gap:10px}
    .sug{
      border:1px solid var(--line);
      background:#fff;border-radius:16px;
      padding:12px 12px;
      cursor:pointer;
      display:flex; flex-direction:column; gap:4px;
      transition: box-shadow .2s ease, transform .06s ease, border-color .2s ease;
    }
    .sug strong{font-size:16px;font-weight:1000}
    .sug span{font-size:13px;color:var(--muted)}
    .sug:hover{border-color:rgba(46,160,138,.38);box-shadow:0 14px 28px rgba(46,160,138,.10);transform:translateY(-1px)}

    .cases{padding:12px 12px;display:flex;flex-direction:column;gap:12px;max-height:calc(100vh - 305px);overflow:auto}
    .case-card{
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px 14px;
      background:#fff;
    }
    .case-title{font-weight:1000;font-size:16px;margin:0 0 6px}
    .case-sub{font-size:14px;color:var(--muted);margin:0}

    .shead{
      padding:16px 16px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background:linear-gradient(180deg,#fff,#fbfcfe);
    }
    .title{display:flex;align-items:center;gap:12px}
    .icon{
      width:40px;height:40px;border-radius:16px;
      display:grid;place-items:center;
      background:linear-gradient(180deg, rgba(46,160,138,.18), rgba(46,160,138,.08));
      border:1px solid rgba(46,160,138,.22);
      color:#0b3b32;font-weight:1000;font-size:14px;
      flex:0 0 auto;
    }
    .shead h3{
      margin:0;
      font-size:22px;
      font-weight:1000;
      letter-spacing:.2px;
    }
    .meta{font-size:14px;color:var(--muted);white-space:nowrap}
    .sbody{padding:16px 16px 18px}

    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab{
      border-radius:999px;
      padding:11px 14px;
      font-size:14px;
      font-weight:1000;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      transition:transform .06s ease;
    }
    .tab:hover{transform:translateY(-1px)}
    .tab.active{
      background:linear-gradient(180deg, rgba(46,160,138,.16), rgba(46,160,138,.08));
      border-color:rgba(46,160,138,.28);
      color:#0b3b32;
    }

    .actionsRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}

    .list{display:flex;flex-direction:column;gap:12px}
    details.item{
      border:1px solid var(--line);
      border-radius:18px;
      background:#fff;
      overflow:hidden;
      transition: box-shadow .2s ease, border-color .2s ease;
    }
    details.item[open]{border-color:rgba(46,160,138,.25);box-shadow:0 18px 38px rgba(46,160,138,.08)}
    details.item summary{
      list-style:none; cursor:pointer;
      padding:14px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      background:linear-gradient(180deg,#ffffff 0%, #fbfcfe 100%);
      font-weight:1000;
      font-size:16px;
    }
    details.item summary::-webkit-details-marker{display:none}
    .sum-left{display:flex;flex-direction:column;gap:4px}
    .sum-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    .pill2{
      font-size:13px;
      padding:7px 11px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fbfcfe;
      color:var(--text)
    }

    .content{padding:12px 14px 16px;display:flex;flex-direction:column;gap:12px}
    .row2{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}

    .note{
      border:1px solid var(--line);
      background:linear-gradient(180deg,#fbfcfe,#f6f9fd);
      border-radius:16px;
      padding:14px;
      font-size:15px;
      white-space:pre-wrap;
      line-height:1.5;
    }

    .overlay{position:fixed; inset:0; background:rgba(2,6,23,.58);display:none; align-items:center; justify-content:center;padding:18px; z-index:999;}
    .overlay.open{display:flex}
    .modal{
      width:min(1280px, 96vw);
      max-height:92vh;
      background:var(--card);
      border-radius:24px;
      box-shadow:0 28px 90px rgba(0,0,0,.36);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
      display:flex;flex-direction:column;
    }
    .modalhead{
      padding:16px 16px;
      background:linear-gradient(180deg,#fff,#fbfcfe);
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .modalhead h4{margin:0;font-size:20px;font-weight:1000}
    .xbtn{
      width:44px;height:44px;border-radius:16px;
      border:1px solid var(--line); background:#fff; cursor:pointer;
      font-weight:1000;font-size:16px;
    }
    .modalbody{
      padding:16px 16px 18px;
      display:grid;
      grid-template-columns: 1.15fr 1fr;
      gap:14px;
      overflow:auto;
    }

    textarea, input[type="text"], input[type="date"], select{
      width:100%;
      padding:14px;
      border-radius:16px;
      border:1px solid var(--line);
      outline:none;
      font-size:15px;
      line-height:1.5;
      background:#fbfcfe;
    }
    textarea{min-height:150px;resize:vertical}
    textarea:focus, input:focus, select:focus{
      border-color:rgba(46,160,138,.55);
      box-shadow:0 0 0 4px rgba(46,160,138,.12);
      background:#fff
    }

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .fieldlabel{font-size:14px;color:var(--muted);margin:0 0 8px;font-weight:900}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top:12px}
    .hint{font-size:14px;color:var(--muted)}
    .kbd{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size:13px;border:1px solid var(--line);
      background:#fff;padding:5px 9px;border-radius:12px;color:#0f172a
    }

    /* Test modal */
    .testWrap{display:flex;flex-direction:column;gap:12px}
    .testCard{
      border:1px solid var(--line);
      border-radius:18px;
      background:#fff;
      padding:14px;
    }
    .testTitle{font-weight:1000;font-size:18px;margin:0 0 8px}
    .testMeta{color:var(--muted);font-size:14px;margin:0 0 12px}
    .videoBox{
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      background:#000;
    }
    .videoBox video, .videoBox iframe{width:100%;height:360px;border:0;display:block;background:#000}

    .toast{
      position:fixed; right:16px; bottom:16px;
      background:#0b1220; color:#fff;
      padding:12px 14px;
      border-radius:16px;
      font-size:14px;
      box-shadow:0 22px 60px rgba(0,0,0,.28);
      display:none; z-index:2000;
      max-width:min(520px, 92vw);
      white-space:pre-wrap;
      border:1px solid rgba(255,255,255,.10);
    }
    .toast.show{display:block}

    @media (max-width:1020px){
      .layout{grid-template-columns:1fr}
      .modalbody{grid-template-columns:1fr}
      .grid2{grid-template-columns:1fr}
      .videoBox video, .videoBox iframe{height:260px}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="left">
        <div class="badge">FP</div>
        <div class="pt-title">
          <h1 id="patientTitle">FISIOPRO</h1>
          <p id="patientSubtitle">Seleziona un paziente per vedere la storia clinica</p>
        </div>
      </div>
      <div class="top-actions">
        <div class="pill ghost" id="btnAgenda">Agenda</div>
        <div class="pill light" id="btnSmart">Acquisizione intelligente</div>
        <div class="pill" id="btnDocuments">Documenti</div>
      </div>
    </div>

    <div class="layout">
      <!-- SIDEBAR -->
      <aside class="side">
        <div class="head">
          <h2>Paziente</h2>
          <button class="btn primary" id="btnClear">Reset</button>
        </div>

        <div class="panel">
          <input class="search" id="patientSearch" placeholder="Cerca paziente (nome/cognome)..." autocomplete="off" />
          <div class="suggest" id="suggest"></div>
        </div>

        <div class="cases" id="patientInfo">
          <div class="case-card">
            <div class="case-title">Nessun paziente selezionato</div>
            <p class="case-sub">Cerca e clicca un nome</p>
          </div>
        </div>
      </aside>

      <!-- MAIN -->
      <main class="main">
        <section class="section">
          <div class="shead">
            <div class="title">
              <div class="icon">SC</div>
              <div>
                <h3>Storia clinica</h3>
                <div class="meta" id="countMeta">—</div>
              </div>
            </div>

            <div class="actionsRow">
              <div class="tabs">
                <button class="tab active" id="tabTreatments">Trattamenti</button>
                <button class="tab" id="tabEvaluations">Valutazioni</button>
              </div>

              <button class="btn soft" id="btnLoadMore" style="display:none;">Carica altri</button>
              <button class="btn save" id="btnNewRecord" disabled>Nuovo</button>
            </div>
          </div>

          <div class="sbody">
            <div class="list" id="list"></div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- MODAL TRATTAMENTO -->
  <div class="overlay" id="overlayTreatment">
    <div class="modal">
      <div class="modalhead">
        <h4>Trattamento</h4>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn soft" id="btnAttachTrt">Allegati</button>
          <button class="xbtn" id="btnCloseTrt">X</button>
        </div>
      </div>

      <div class="modalbody">
        <div>
          <div class="section" style="box-shadow:none;border:1px solid var(--line)">
            <div class="shead">
              <div class="title">
                <div class="icon">NF</div>
                <div>
                  <h3>Note fisioterapista</h3>
                  <div class="meta" id="metaTrt">Record: —</div>
                </div>
              </div>
            </div>
            <div class="sbody"><textarea id="trtNote" placeholder="Scrivi le note..."></textarea></div>
          </div>

          <div style="height:12px"></div>

          <div class="section" style="box-shadow:none;border:1px solid var(--line)">
            <div class="shead"><div class="title"><div class="icon">TE</div><h3>Trattamento eseguito</h3></div></div>
            <div class="sbody"><textarea id="trtDone" placeholder="Descrivi il trattamento eseguito..."></textarea></div>
          </div>

          <div style="height:12px"></div>

          <div class="section" style="box-shadow:none;border:1px solid var(--line)">
            <div class="shead"><div class="title"><div class="icon">IP</div><h3>Indicazioni prossima seduta</h3></div></div>
            <div class="sbody"><textarea id="trtNext" placeholder="Indicazioni per la prossima seduta..."></textarea></div>
          </div>

          <div class="toolbar">
            <span class="hint"><span class="kbd">Ctrl/Command + S</span> salva</span>
            <button class="btn" id="btnCancelTrt">Annulla</button>
            <button class="btn save" id="btnSaveTrt">Salva</button>
          </div>
        </div>

        <div>
          <div class="note">
            Body map trattamento: già presente nel progetto precedente.
            Se vuoi, lo reinseriamo identico come nel modal trattamenti precedente (campo BODY T).
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL VALUTAZIONE -->
  <div class="overlay" id="overlayEval">
    <div class="modal">
      <div class="modalhead">
        <h4>Valutazione</h4>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn soft" id="btnOpenTests">Test clinici</button>
          <button class="xbtn" id="btnCloseEval">X</button>
        </div>
      </div>

      <div class="modalbody">
        <div>
          <div class="section" style="box-shadow:none;border:1px solid var(--line)">
            <div class="shead">
              <div class="title">
                <div class="icon">DV</div>
                <div>
                  <h3>Dati visita</h3>
                  <div class="meta" id="metaEval">Record: —</div>
                </div>
              </div>
            </div>
            <div class="sbody">
              <div class="grid2">
                <div>
                  <div class="fieldlabel">Data visita</div>
                  <input type="date" id="evDate" />
                </div>
                <div>
                  <div class="fieldlabel">Scala dolore NRS</div>
                  <input type="text" id="evNrs" placeholder="0-10" />
                </div>
              </div>
              <div style="height:12px"></div>
              <div>
                <div class="fieldlabel">Dolore sede</div>
                <input type="text" id="evPainSite" placeholder="Esempio: spalla destra, ginocchio..." />
              </div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="section" style="box-shadow:none;border:1px solid var(--line)">
            <div class="shead"><div class="title"><div class="icon">PV</div><h3>Prima valutazione</h3></div></div>
            <div class="sbody"><textarea id="evFirst" placeholder="Testo libero..."></textarea></div>
          </div>

          <div style="height:12px"></div>

          <div class="section" style="box-shadow:none;border:1px solid var(--line)">
            <div class="shead"><div class="title"><div class="icon">AR</div><h3>Anamnesi remota</h3></div></div>
            <div class="sbody"><textarea id="evRemote" placeholder="Anamnesi remota..."></textarea></div>
          </div>

          <div style="height:12px"></div>

          <div class="section" style="box-shadow:none;border:1px solid var(--line)">
            <div class="shead"><div class="title"><div class="icon">AP</div><h3>Anamnesi recente</h3></div></div>
            <div class="sbody"><textarea id="evRecent" placeholder="Anamnesi recente..."></textarea></div>
          </div>

          <div style="height:12px"></div>

          <div class="section" style="box-shadow:none;border:1px solid var(--line)">
            <div class="shead"><div class="title"><div class="icon">NT</div><h3>Note</h3></div></div>
            <div class="sbody"><textarea id="evNotes" placeholder="Note aggiuntive..."></textarea></div>
          </div>

          <div class="toolbar">
            <span class="hint"><span class="kbd">Ctrl/Command + S</span> salva</span>
            <button class="btn" id="btnCancelEval">Annulla</button>
            <button class="btn save" id="btnSaveEval">Salva</button>
          </div>
        </div>

        <div>
          <div class="section" style="box-shadow:none;border:1px solid var(--line)">
            <div class="shead"><div class="title"><div class="icon">TC</div><h3>Test inseriti</h3></div></div>
            <div class="sbody">
              <div class="note" id="evTestsSummary">Nessun test inserito.</div>
              <div style="height:10px"></div>
              <div class="note">
                Nel prossimo step: body map valutazione + VAS multipli (campi già presenti nel tuo CSV: dolore principale/secondario/terziario).
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL TEST CON VIDEO -->
  <div class="overlay" id="overlayTest">
    <div class="modal">
      <div class="modalhead">
        <h4>Test clinico</h4>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="xbtn" id="btnCloseTest">X</button>
        </div>
      </div>

      <div class="modalbody" style="grid-template-columns: 1fr 1fr;">
        <div class="testWrap">
          <div class="testCard">
            <div class="fieldlabel">Categoria</div>
            <select id="testCategory"></select>

            <div style="height:12px"></div>

            <div class="fieldlabel">Test</div>
            <select id="testName"></select>

            <div style="height:12px"></div>

            <div class="fieldlabel">Esito</div>
            <select id="testOutcome">
              <option value="">Seleziona</option>
              <option value="Positivo">Positivo</option>
              <option value="Negativo">Negativo</option>
              <option value="Dubbio">Dubbio</option>
              <option value="Non eseguito">Non eseguito</option>
            </select>

            <div style="height:12px"></div>

            <div class="fieldlabel">Note</div>
            <textarea id="testNotes" placeholder="Note sul test..."></textarea>

            <div class="toolbar">
              <button class="btn" id="btnCancelTest">Annulla</button>
              <button class="btn save" id="btnAddTest">Inserisci in valutazione</button>
            </div>
          </div>
        </div>

        <div class="testWrap">
          <div class="testCard">
            <div class="testTitle" id="testTitle">—</div>
            <div class="testMeta" id="testDesc">—</div>

            <div class="videoBox" id="videoBox">
              <!-- Render video/iframe via JS -->
            </div>

            <div style="height:12px"></div>
            <div class="note" id="testSteps">—</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // Toast
    const toastEl = document.getElementById("toast");
    let toastTimer = null;
    function toast(msg){
      toastEl.textContent = String(msg || "");
      toastEl.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toastEl.classList.remove("show"), 2600);
    }

    // Top actions (mock)
    document.getElementById("btnAgenda").onclick = () => toast("Agenda (step dopo)");
    document.getElementById("btnSmart").onclick = () => toast("Acquisizione intelligente (step dopo)");
    document.getElementById("btnDocuments").onclick = () => toast("Documenti (step dopo)");

    // API
    async function apiSearchPatients(q){
      const r = await fetch(`/api/patients?q=${encodeURIComponent(q)}`);
      const j = await r.json();
      if(!r.ok) throw new Error(j?.error || ("Search failed: " + r.status));
      return j.records || [];
    }

    // Trattamenti
    async function apiListTreatmentsByPatient(patientId, offset){
      const url = `/api/treatments?patientId=${encodeURIComponent(patientId)}` + (offset ? `&offset=${encodeURIComponent(offset)}` : "");
      const r = await fetch(url);
      const j = await r.json();
      if(!r.ok) throw new Error(j?.error || ("List failed: " + r.status));
      return j;
    }
    async function apiLoadTreatment(recordId){
      const r = await fetch(`/api/treatments?id=${encodeURIComponent(recordId)}`);
      const j = await r.json();
      if(!r.ok) throw new Error(j?.error || ("Load failed: " + r.status));
      return j.fields || {};
    }
    async function apiSaveTreatment(recordId, fields){
      const r = await fetch(`/api/treatments`, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ id: recordId, fields })
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j?.error || ("Save failed: " + r.status));
      return j;
    }
    async function apiCreateTreatment(patientId){
      const r = await fetch(`/api/treatments`, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ patientId })
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j?.error || ("Create failed: " + r.status));
      return j;
    }

    // Valutazioni
    async function apiListEvaluationsByPatient(patientId, offset){
      const url = `/api/evaluations?patientId=${encodeURIComponent(patientId)}` + (offset ? `&offset=${encodeURIComponent(offset)}` : "");
      const r = await fetch(url);
      const j = await r.json();
      if(!r.ok) throw new Error(j?.error || ("List failed: " + r.status));
      return j;
    }
    async function apiLoadEvaluation(recordId){
      const r = await fetch(`/api/evaluations?id=${encodeURIComponent(recordId)}`);
      const j = await r.json();
      if(!r.ok) throw new Error(j?.error || ("Load failed: " + r.status));
      return j.fields || {};
    }
    async function apiSaveEvaluation(recordId, fields){
      const r = await fetch(`/api/evaluations`, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ id: recordId, fields })
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j?.error || ("Save failed: " + r.status));
      return j;
    }
    async function apiCreateEvaluation(patientId){
      const r = await fetch(`/api/evaluations`, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ patientId })
      });
      const j = await r.json();
      if(!r.ok) throw new Error(j?.error || ("Create failed: " + r.status));
      return j;
    }

    // UI elements
    const patientSearch = document.getElementById("patientSearch");
    const suggest = document.getElementById("suggest");
    const patientInfo = document.getElementById("patientInfo");
    const patientTitle = document.getElementById("patientTitle");
    const patientSubtitle = document.getElementById("patientSubtitle");
    const listEl = document.getElementById("list");
    const countMeta = document.getElementById("countMeta");
    const btnClear = document.getElementById("btnClear");
    const btnLoadMore = document.getElementById("btnLoadMore");
    const btnNewRecord = document.getElementById("btnNewRecord");

    const tabTreatments = document.getElementById("tabTreatments");
    const tabEvaluations = document.getElementById("tabEvaluations");

    let selectedPatient = null;
    let currentMode = "treatments"; // treatments | evaluations
    let offset = null;
    let loadedCount = 0;

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function clearSuggestions(){ suggest.innerHTML = ""; }

    function renderSuggestions(items){
      if(!items.length){
        suggest.innerHTML = `<div class="note">Nessun risultato</div>`;
        return;
      }
      suggest.innerHTML = "";
      items.forEach(p=>{
        const el = document.createElement("div");
        el.className = "sug";
        el.innerHTML = `
          <strong>${escapeHtml(p.name)}</strong>
          <span>${p.dob ? "Nato/a: " + escapeHtml(p.dob) : ""}${p.phone ? (p.dob ? " · " : "") + "Tel: " + escapeHtml(p.phone) : ""}</span>
        `;
        el.onclick = () => selectPatient(p);
        suggest.appendChild(el);
      });
    }

    async function selectPatient(p){
      selectedPatient = p;
      clearSuggestions();
      patientSearch.value = p.name;

      patientTitle.textContent = "FISIOPRO — " + p.name;
      patientSubtitle.textContent = "Storia clinica del paziente";
      btnNewRecord.disabled = false;

      patientInfo.innerHTML = `
        <div class="case-card">
          <div class="case-title">${escapeHtml(p.name)}</div>
          <p class="case-sub">Record ID: ${escapeHtml(p.id)}</p>
        </div>
      `;

      offset = null; loadedCount = 0;
      btnLoadMore.style.display = "none";
      await loadMore(true);
    }

    btnClear.onclick = () => {
      selectedPatient = null;
      offset = null; loadedCount = 0;

      patientSearch.value = "";
      clearSuggestions();

      patientTitle.textContent = "FISIOPRO";
      patientSubtitle.textContent = "Seleziona un paziente per vedere la storia clinica";
      btnNewRecord.disabled = true;

      patientInfo.innerHTML = `
        <div class="case-card">
          <div class="case-title">Nessun paziente selezionato</div>
          <p class="case-sub">Cerca e clicca un nome</p>
        </div>
      `;

      listEl.innerHTML = `<div class="note">Seleziona un paziente per caricare i record.</div>`;
      countMeta.textContent = "—";
      btnLoadMore.style.display = "none";
    };

    // Search debounce
    let searchTimer = null;
    patientSearch.addEventListener("input", () => {
      const q = patientSearch.value.trim();
      clearTimeout(searchTimer);
      if(!q){ clearSuggestions(); return; }
      searchTimer = setTimeout(async ()=>{
        try{ renderSuggestions(await apiSearchPatients(q)); }
        catch(err){ suggest.innerHTML = `<div class="note">Errore ricerca: ${escapeHtml(err.message)}</div>`; }
      }, 200);
    });

    // Tabs
    tabTreatments.onclick = async () => {
      currentMode = "treatments";
      tabTreatments.classList.add("active");
      tabEvaluations.classList.remove("active");
      btnNewRecord.textContent = "Nuovo trattamento";
      offset = null; loadedCount = 0;
      await loadMore(true);
    };

    tabEvaluations.onclick = async () => {
      currentMode = "evaluations";
      tabEvaluations.classList.add("active");
      tabTreatments.classList.remove("active");
      btnNewRecord.textContent = "Nuova valutazione";
      offset = null; loadedCount = 0;
      await loadMore(true);
    };

    // Init button label
    btnNewRecord.textContent = "Nuovo trattamento";

    btnLoadMore.onclick = () => loadMore(false);

    // List render helpers
    function short(text, n=200){
      const s = (text || "").toString().replace(/\s+/g, " ").trim();
      if(!s) return "";
      return s.length > n ? s.slice(0, n-1) + "…" : s;
    }

    function pickDateTrt(fields){
      return fields["DATA TRATTAMENTO"] || fields["Data seduta"] || fields["DATA"] || "";
    }
    function pickTitleTrt(fields){
      return fields["Nome trattamento"] || fields["TIPO PRESTAZIONE"] || fields["Tipo seduta"] || "Trattamento";
    }

    function renderTreatmentItem(recordId, fields){
      const wrap = document.createElement("details");
      wrap.className = "item";

      const date = pickDateTrt(fields);
      const title = pickTitleTrt(fields);

      const lat = fields["Lateralità"] ? String(fields["Lateralità"]) : "";
      const area = fields["Struttura Anatomica"] ? String(fields["Struttura Anatomica"]) : "";
      const pat = fields["Patologia"] ? String(fields["Patologia"]) : "";

      const note = fields["Note Fisioterapista"] || "";
      const eseguito = fields["Trattamento eseguito"] || "";
      const indic = fields["Indicazioni prossima seduta"] || "";

      wrap.innerHTML = `
        <summary>
          <div class="sum-left">
            <div><strong>${escapeHtml(title)}</strong>${date ? " · " + escapeHtml(date) : ""}</div>
            <div style="color:var(--muted);font-size:14px">${escapeHtml([area, lat, pat].filter(Boolean).join(" · "))}</div>
          </div>
          <div class="sum-right">
            ${area ? `<span class="pill2">${escapeHtml(area)}</span>` : ""}
            ${lat ? `<span class="pill2">${escapeHtml(lat)}</span>` : ""}
          </div>
        </summary>
        <div class="content">
          <div class="note"><strong>Note fisioterapista</strong>\n${escapeHtml(short(note) || "—")}\n\n<strong>Trattamento eseguito</strong>\n${escapeHtml(short(eseguito) || "—")}\n\n<strong>Indicazioni prossima seduta</strong>\n${escapeHtml(short(indic) || "—")}</div>
          <div class="row2">
            <span class="hint">Record: ${escapeHtml(recordId)}</span>
            <button class="btn primary js-edit" type="button">Modifica</button>
          </div>
        </div>
      `;
      wrap.querySelector(".js-edit").onclick = () => openTreatmentEditor(recordId);
      return wrap;
    }

    function pickDateEv(fields){
      return fields["DATA VISITA"] || "";
    }
    function pickTitleEv(fields){
      const sede = fields["DOLORE SEDE"] ? String(fields["DOLORE SEDE"]) : "";
      return sede ? ("Valutazione · " + sede) : "Valutazione";
    }

    function renderEvaluationItem(recordId, fields){
      const wrap = document.createElement("details");
      wrap.className = "item";

      const date = pickDateEv(fields);
      const title = pickTitleEv(fields);
      const nrs = fields["SCALA DOLORE NRS"] ? String(fields["SCALA DOLORE NRS"]) : "";

      const pv = fields["PRIMA VALUTAZIONE"] || "";
      const ar = fields["ANAMNESI REMOTA"] || "";
      const ap = fields["ANAMNESI RECENTE"] || "";
      const note = fields["NOTE"] || "";

      const qt = fields["QUICK TEST"] || "";
      const st = fields["SPECIAL TEST"] || "";
      const tn = fields["TEST NEUROLOGICO"] || "";

      const testsLine = [qt, st, tn].filter(Boolean).join(" · ");

      wrap.innerHTML = `
        <summary>
          <div class="sum-left">
            <div><strong>${escapeHtml(title)}</strong>${date ? " · " + escapeHtml(date) : ""}</div>
            <div style="color:var(--muted);font-size:14px">${escapeHtml(testsLine || "Nessun test inserito")}</div>
          </div>
          <div class="sum-right">
            ${nrs ? `<span class="pill2">NRS ${escapeHtml(nrs)}</span>` : ""}
          </div>
        </summary>
        <div class="content">
          <div class="note"><strong>Prima valutazione</strong>\n${escapeHtml(short(pv) || "—")}\n\n<strong>Anamnesi remota</strong>\n${escapeHtml(short(ar) || "—")}\n\n<strong>Anamnesi recente</strong>\n${escapeHtml(short(ap) || "—")}\n\n<strong>Note</strong>\n${escapeHtml(short(note) || "—")}</div>
          <div class="row2">
            <span class="hint">Record: ${escapeHtml(recordId)}</span>
            <button class="btn primary js-edit" type="button">Modifica</button>
          </div>
        </div>
      `;
      wrap.querySelector(".js-edit").onclick = () => openEvaluationEditor(recordId);
      return wrap;
    }

    async function loadMore(reset){
      if(!selectedPatient){
        listEl.innerHTML = `<div class="note">Seleziona un paziente per caricare i record.</div>`;
        countMeta.textContent = "—";
        btnLoadMore.style.display = "none";
        return;
      }

      try{
        if(reset){
          listEl.innerHTML = `<div class="note">Caricamento...</div>`;
          offset = null; loadedCount = 0;
          btnLoadMore.style.display = "none";
        }

        const data = currentMode === "treatments"
          ? await apiListTreatmentsByPatient(selectedPatient.id, reset ? null : offset)
          : await apiListEvaluationsByPatient(selectedPatient.id, reset ? null : offset);

        const records = data.records || [];
        offset = data.offset || null;

        if(reset){
          listEl.innerHTML = "";
          loadedCount = 0;
        }

        if(!records.length && reset){
          listEl.innerHTML = `<div class="note">Nessun record trovato.</div>`;
        } else {
          records.forEach(r=>{
            const node = currentMode === "treatments"
              ? renderTreatmentItem(r.id, r.fields)
              : renderEvaluationItem(r.id, r.fields);
            listEl.appendChild(node);
          });
          loadedCount += records.length;
        }

        countMeta.textContent = `${loadedCount} record caricati`;
        btnLoadMore.style.display = offset ? "" : "none";
        btnNewRecord.textContent = currentMode === "treatments" ? "Nuovo trattamento" : "Nuova valutazione";
      }catch(err){
        listEl.innerHTML = `<div class="note">Errore: ${escapeHtml(err.message)}</div>`;
        btnLoadMore.style.display = "none";
      }
    }

    // NEW record
    btnNewRecord.onclick = async () => {
      if(!selectedPatient) return;
      btnNewRecord.disabled = true;
      try{
        if(currentMode === "treatments"){
          const created = await apiCreateTreatment(selectedPatient.id);
          toast("Creato trattamento");
          await openTreatmentEditor(created.id);
        } else {
          const created = await apiCreateEvaluation(selectedPatient.id);
          toast("Creata valutazione");
          await openEvaluationEditor(created.id);
        }
        await loadMore(true);
      } catch(err){
        toast("Errore:\n" + err.message);
      } finally {
        btnNewRecord.disabled = false;
      }
    };

    // ----------------------------
    // Treatment modal (semplice)
    // ----------------------------
    const overlayTreatment = document.getElementById("overlayTreatment");
    const metaTrt = document.getElementById("metaTrt");
    const trtNote = document.getElementById("trtNote");
    const trtDone = document.getElementById("trtDone");
    const trtNext = document.getElementById("trtNext");

    function closeTreatment(){
      overlayTreatment.classList.remove("open");
      overlayTreatment.dataset.current = "";
      metaTrt.textContent = "Record: —";
    }
    document.getElementById("btnCloseTrt").onclick = closeTreatment;
    document.getElementById("btnCancelTrt").onclick = closeTreatment;
    overlayTreatment.addEventListener("click", (e)=>{ if(e.target === overlayTreatment) closeTreatment(); });
    document.getElementById("btnAttachTrt").onclick = () => toast("Allegati trattamenti (step dopo)");

    async function openTreatmentEditor(recordId){
      overlayTreatment.classList.add("open");
      overlayTreatment.dataset.current = recordId;
      metaTrt.textContent = "Record: " + recordId;
      trtNote.value = "Caricamento...";
      trtDone.value = "";
      trtNext.value = "";

      try{
        const f = await apiLoadTreatment(recordId);
        trtNote.value = f["Note Fisioterapista"] || "";
        trtDone.value = f["Trattamento eseguito"] || "";
        trtNext.value = f["Indicazioni prossima seduta"] || "";
        toast("Caricato");
      }catch(err){
        toast("Errore caricamento:\n" + err.message);
      }
    }

    document.getElementById("btnSaveTrt").onclick = async () => {
      const id = overlayTreatment.dataset.current;
      if(!id) return;
      try{
        await apiSaveTreatment(id, {
          "Note Fisioterapista": trtNote.value,
          "Trattamento eseguito": trtDone.value,
          "Indicazioni prossima seduta": trtNext.value
        });
        toast("Salvato");
        closeTreatment();
        await loadMore(true);
      }catch(err){
        toast("Errore salvataggio:\n" + err.message);
      }
    };

    // ----------------------------
    // Evaluation modal + Tests
    // ----------------------------
    const overlayEval = document.getElementById("overlayEval");
    const metaEval = document.getElementById("metaEval");
    const evDate = document.getElementById("evDate");
    const evNrs = document.getElementById("evNrs");
    const evPainSite = document.getElementById("evPainSite");
    const evFirst = document.getElementById("evFirst");
    const evRemote = document.getElementById("evRemote");
    const evRecent = document.getElementById("evRecent");
    const evNotes = document.getElementById("evNotes");
    const evTestsSummary = document.getElementById("evTestsSummary");

    // Stato test in memoria (poi viene scritto su campi Airtable: QUICK TEST / SPECIAL TEST / TEST NEUROLOGICO)
    const evalTestsState = {
      quick: { name:"", outcome:"", notes:"" },
      special: { name:"", outcome:"", notes:"" },
      neuro: { name:"", outcome:"", notes:"" }
    };

    function evalTestsToText(){
      const lines = [];
      if(evalTestsState.quick.name)   lines.push(`Quick test: ${evalTestsState.quick.name} · ${evalTestsState.quick.outcome || "—"}\n${evalTestsState.quick.notes || ""}`.trim());
      if(evalTestsState.special.name) lines.push(`Special test: ${evalTestsState.special.name} · ${evalTestsState.special.outcome || "—"}\n${evalTestsState.special.notes || ""}`.trim());
      if(evalTestsState.neuro.name)   lines.push(`Test neurologico: ${evalTestsState.neuro.name} · ${evalTestsState.neuro.outcome || "—"}\n${evalTestsState.neuro.notes || ""}`.trim());
      return lines.length ? lines.join("\n\n") : "Nessun test inserito.";
    }

    function closeEval(){
      overlayEval.classList.remove("open");
      overlayEval.dataset.current = "";
      metaEval.textContent = "Record: —";
    }
    document.getElementById("btnCloseEval").onclick = closeEval;
    document.getElementById("btnCancelEval").onclick = closeEval;
    overlayEval.addEventListener("click", (e)=>{ if(e.target === overlayEval) closeEval(); });

    async function openEvaluationEditor(recordId){
      overlayEval.classList.add("open");
      overlayEval.dataset.current = recordId;
      metaEval.textContent = "Record: " + recordId;

      evDate.value = "";
      evNrs.value = "";
      evPainSite.value = "";
      evFirst.value = "Caricamento...";
      evRemote.value = "";
      evRecent.value = "";
      evNotes.value = "";

      evalTestsState.quick = { name:"", outcome:"", notes:"" };
      evalTestsState.special = { name:"", outcome:"", notes:"" };
      evalTestsState.neuro = { name:"", outcome:"", notes:"" };
      evTestsSummary.textContent = evalTestsToText();

      try{
        const f = await apiLoadEvaluation(recordId);
        evDate.value = (f["DATA VISITA"] || "").slice(0,10);
        evNrs.value = f["SCALA DOLORE NRS"] || "";
        evPainSite.value = f["DOLORE SEDE"] || "";
        evFirst.value = f["PRIMA VALUTAZIONE"] || "";
        evRemote.value = f["ANAMNESI REMOTA"] || "";
        evRecent.value = f["ANAMNESI RECENTE"] || "";
        evNotes.value = f["NOTE"] || "";

        // Se già presenti, li mostro come testo (base)
        if(f["QUICK TEST"]) evalTestsState.quick.name = String(f["QUICK TEST"]);
        if(f["SPECIAL TEST"]) evalTestsState.special.name = String(f["SPECIAL TEST"]);
        if(f["TEST NEUROLOGICO"]) evalTestsState.neuro.name = String(f["TEST NEUROLOGICO"]);
        evTestsSummary.textContent = evalTestsToText();

        toast("Caricato");
      }catch(err){
        toast("Errore caricamento:\n" + err.message);
      }
    }

    document.getElementById("btnSaveEval").onclick = async () => {
      const id = overlayEval.dataset.current;
      if(!id) return;

      const fields = {
        "DATA VISITA": evDate.value || "",
        "SCALA DOLORE NRS": evNrs.value || "",
        "DOLORE SEDE": evPainSite.value || "",
        "PRIMA VALUTAZIONE": evFirst.value || "",
        "ANAMNESI REMOTA": evRemote.value || "",
        "ANAMNESI RECENTE": evRecent.value || "",
        "NOTE": evNotes.value || "",
        "QUICK TEST": evalTestsState.quick.name || "",
        "SPECIAL TEST": evalTestsState.special.name || "",
        "TEST NEUROLOGICO": evalTestsState.neuro.name || ""
      };

      try{
        await apiSaveEvaluation(id, fields);
        toast("Salvato");
        closeEval();
        await loadMore(true);
      }catch(err){
        toast("Errore salvataggio:\n" + err.message);
      }
    };

    // ----------------------------
    // Test modal con video
    // ----------------------------
    const overlayTest = document.getElementById("overlayTest");
    const btnCloseTest = document.getElementById("btnCloseTest");
    const btnCancelTest = document.getElementById("btnCancelTest");
    const btnAddTest = document.getElementById("btnAddTest");
    const testCategory = document.getElementById("testCategory");
    const testName = document.getElementById("testName");
    const testOutcome = document.getElementById("testOutcome");
    const testNotes = document.getElementById("testNotes");
    const testTitle = document.getElementById("testTitle");
    const testDesc = document.getElementById("testDesc");
    const testSteps = document.getElementById("testSteps");
    const videoBox = document.getElementById("videoBox");

    // Libreria test (qui puoi mettere video mp4 o link YouTube/embed)
    // Se vuoi: nel prossimo step la facciamo arrivare da Airtable (tabella "TEST CLINICI") con allegati video.
    const TEST_LIBRARY = {
      "Quick test": [
        {
          name: "Screening spalla rapido",
          desc: "Checklist breve per decidere se approfondire cuffia / impingement / instabilità.",
          steps: "1) Osservazione\n2) ROM attivo\n3) Resistenza isometrica breve\n4) Dolore e limitazioni",
          video: { type:"youtube", src:"https://www.youtube.com/embed/ysz5S6PUM-U" }
        }
      ],
      "Special test": [
        {
          name: "Jobe / Empty Can",
          desc: "Valutazione sovraspinato / cuffia dei rotatori.",
          steps: "1) Abduzione 90°\n2) Intraruotazione (pollici verso il basso)\n3) Resistenza verso il basso\n4) Confronto lato controlaterale",
          video: { type:"youtube", src:"https://www.youtube.com/embed/ysz5S6PUM-U" }
        }
      ],
      "Test neurologico": [
        {
          name: "Slump test",
          desc: "Valuta tensione neurale (catena posteriore / sciatico).",
          steps: "1) Seduto, flessione toracica\n2) Estensione ginocchio\n3) Dorsiflessione\n4) Differenziazione con estensione cervicale",
          video: { type:"youtube", src:"https://www.youtube.com/embed/ysz5S6PUM-U" }
        }
      ]
    };

    function closeTest(){
      overlayTest.classList.remove("open");
      overlayTest.dataset.target = "";
    }
    btnCloseTest.onclick = closeTest;
    btnCancelTest.onclick = closeTest;
    overlayTest.addEventListener("click", (e)=>{ if(e.target === overlayTest) closeTest(); });

    function renderVideo(v){
      videoBox.innerHTML = "";
      if(!v || !v.src){
        videoBox.innerHTML = `<div class="note" style="border:0;background:transparent;color:#fff">Nessun video disponibile</div>`;
        return;
      }
      if(v.type === "youtube"){
        const ifr = document.createElement("iframe");
        ifr.src = v.src;
        ifr.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
        ifr.allowFullscreen = true;
        videoBox.appendChild(ifr);
        return;
      }
      // mp4
      const vid = document.createElement("video");
      vid.src = v.src;
      vid.controls = true;
      videoBox.appendChild(vid);
    }

    function refreshTestUI(){
      const cat = testCategory.value;
      const items = TEST_LIBRARY[cat] || [];
      const idx = Math.max(0, testName.selectedIndex);
      const item = items[idx] || items[0];

      testTitle.textContent = item ? item.name : "—";
      testDesc.textContent = item ? item.desc : "—";
      testSteps.textContent = item ? item.steps : "—";
      renderVideo(item ? item.video : null);
    }

    function openTestModal(target){
      overlayTest.classList.add("open");
      overlayTest.dataset.target = target;

      // fill categories
      testCategory.innerHTML = "";
      Object.keys(TEST_LIBRARY).forEach(k=>{
        const opt = document.createElement("option");
        opt.value = k; opt.textContent = k;
        testCategory.appendChild(opt);
      });

      // set default category by target
      if(target === "quick") testCategory.value = "Quick test";
      if(target === "special") testCategory.value = "Special test";
      if(target === "neuro") testCategory.value = "Test neurologico";

      // fill tests
      fillTestsForCategory(testCategory.value);

      testOutcome.value = "";
      testNotes.value = "";
      refreshTestUI();
    }

    function fillTestsForCategory(cat){
      testName.innerHTML = "";
      (TEST_LIBRARY[cat] || []).forEach(t=>{
        const opt = document.createElement("option");
        opt.value = t.name; opt.textContent = t.name;
        testName.appendChild(opt);
      });
    }

    testCategory.onchange = () => {
      fillTestsForCategory(testCategory.value);
      refreshTestUI();
    };
    testName.onchange = () => refreshTestUI();

    btnAddTest.onclick = () => {
      const target = overlayTest.dataset.target;
      const cat = testCategory.value;
      const name = testName.value || "";
      const out = testOutcome.value || "";
      const notes = testNotes.value || "";

      if(!target || !name){
        toast("Seleziona un test");
        return;
      }

      if(target === "quick") evalTestsState.quick = { name, outcome: out, notes };
      if(target === "special") evalTestsState.special = { name, outcome: out, notes };
      if(target === "neuro") evalTestsState.neuro = { name, outcome: out, notes };

      evTestsSummary.textContent = evalTestsToText();
      closeTest();
      toast("Test inserito");
    };

    // Bottone "Test clinici" dentro valutazione
    document.getElementById("btnOpenTests").onclick = () => {
      // qui scegliamo quale categoria aprire: per ora apro Special test come default
      openTestModal("special");
    };

    // Shortcut save
    document.addEventListener("keydown", (e) => {
      const isMac = navigator.platform.toUpperCase().includes("MAC");
      const mod = isMac ? e.metaKey : e.ctrlKey;

      if(mod && e.key.toLowerCase() === "s"){
        if(overlayEval.classList.contains("open")){ e.preventDefault(); document.getElementById("btnSaveEval").click(); }
        if(overlayTreatment.classList.contains("open")){ e.preventDefault(); document.getElementById("btnSaveTrt").click(); }
      }
      if(e.key === "Escape"){
        if(overlayTest.classList.contains("open")) closeTest();
        else if(overlayEval.classList.contains("open")) closeEval();
        else if(overlayTreatment.classList.contains("open")) closeTreatment();
      }
    });

    // First paint
    listEl.innerHTML = `<div class="note">Seleziona un paziente per caricare i record.</div>`;
  </script>
</body>
</html>
