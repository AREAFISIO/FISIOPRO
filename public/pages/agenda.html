<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FisioPro – Agenda</title>

  <!-- STESSO CSS DEL GESTIONALE -->
  <link rel="stylesheet" href="/assets/app.css" />

  <!-- SICUREZZA -->
  <script src="/assets/auth-guard.js"></script>
  <script src="/assets/session-timeout.js"></script>

  <style>
    body { font-size: 18px; }

    h1 {
      font-size: 28px;
      font-weight: 900;
      margin: 0;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      padding: 16px;
    }

    .user {
      font-size: 15px;
      opacity: .75;
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    input[type="date"] {
      padding: 10px 14px;
      font-size: 16px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(0,0,0,.15);
      color: inherit;
      font-weight: 700;
    }

    button {
      padding: 10px 14px;
      font-size: 16px;
      font-weight: 800;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.25);
      background: rgba(0,0,0,.2);
      cursor: pointer;
    }

    button:disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    .wrap {
      padding: 0 16px 24px;
    }

    .card {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 16px;
      padding: 14px;
    }

    .headerline {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-weight: 900;
    }

    .muted {
      opacity: .7;
    }

    .list {
      display: grid;
      gap: 10px;
    }

    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px;
      border-radius: 14px;
      cursor: pointer;
    }

    .row:hover {
      background: rgba(255,255,255,.08);
    }

    .time {
      font-weight: 900;
      font-size: 18px;
    }

    .patient {
      opacity: .85;
      font-size: 16px;
    }

    .pill {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 900;
      border: 1px solid rgba(255,255,255,.25);
    }

    .error {
      display: none;
      margin-bottom: 14px;
      padding: 12px;
      border-radius: 12px;
      background: #fff5f5;
      border: 1px solid #fed7d7;
      color: #7a1b1b;
      font-weight: 700;
    }
  </style>
</head>

<body>

  <!-- TOP BAR -->
  <div class="topbar">
    <div>
      <h1>Agenda</h1>
      <div id="whoami" class="user">Caricamento sessione…</div>
    </div>

    <div class="controls">
      <input id="datePick" type="date" />
      <button id="refreshBtn">Aggiorna</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="wrap">
    <div id="errorBox" class="error"></div>

    <div class="card">
      <div class="headerline">
        <div>Appuntamenti</div>
        <div id="countBox" class="muted">—</div>
      </div>

      <div id="list" class="list">
        <div class="muted">Caricamento agenda…</div>
      </div>
    </div>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);

    function formatTime(iso) {
      const d = new Date(iso);
      return d.toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" });
    }

    function todayISO() {
      const d = new Date();
      return d.toISOString().slice(0, 10);
    }

    function showError(msg) {
      $("#errorBox").textContent = msg;
      $("#errorBox").style.display = "block";
    }

    function clearError() {
      $("#errorBox").style.display = "none";
      $("#errorBox").textContent = "";
    }

    // LOGOUT
    $("#logoutBtn").addEventListener("click", async () => {
      await fetch("/api/auth-logout", { method: "POST" });
      window.location.href = "/";
    });

    // ATTENDO SESSIONE (da auth-guard.js)
    function waitSession() {
      return new Promise((resolve) => {
        let tries = 0;
        const t = setInterval(() => {
          tries++;
          if (window.FP_SESSION) {
            clearInterval(t);
            resolve(window.FP_SESSION);
          }
          if (tries > 100) {
            clearInterval(t);
            resolve(null);
          }
        }, 50);
      });
    }

    async function loadAgenda(date) {
      clearError();
      $("#refreshBtn").disabled = true;
      $("#list").innerHTML = `<div class="muted">Caricamento…</div>`;

      try {
        // 1) Appuntamenti (filtrati dal backend per ruolo)
        const rA = await fetch(`/api/appointments?from=${date}&to=${date}`);
        const a = await rA.json();
        if (!a.ok) throw new Error("Errore appuntamenti");

        // 2) ID pazienti
        const ids = [...new Set(a.records.flatMap(r => r.patientIds || []))];

        // 3) Carico anagrafica
        let patients = {};
        if (ids.length) {
          const rP = await fetch(`/api/patients-batch?ids=${ids.join(",")}`);
          const p = await rP.json();
          if (p.ok) {
            p.records.forEach(r => patients[r.id] = r.fields);
          }
        }

        $("#countBox").textContent = `${a.records.length} appuntamenti`;

        if (!a.records.length) {
          $("#list").innerHTML = `<div class="muted">Nessun appuntamento</div>`;
          return;
        }

        // 4) Render
        $("#list").innerHTML = a.records.map(ap => {
          const pid = ap.patientIds?.[0] || "";
          const pf = patients[pid] || {};
          const nome = `${pf.Nome || ""} ${pf.Cognome || ""}`.trim() || "Paziente";

          return `
            <div class="row" data-patient="${pid}">
              <div>
                <div class="time">
                  ${formatTime(ap.start)} – ${formatTime(ap.end)}
                  <span class="muted">(${ap.durata || ""} min)</span>
                </div>
                <div class="patient">${nome}</div>
              </div>
              <div class="pill">Apri</div>
            </div>
          `;
        }).join("");

        // 5) Click → scheda paziente
        document.querySelectorAll(".row").forEach(row => {
          row.addEventListener("click", () => {
            const id = row.dataset.patient;
            if (id) window.location.href = `/pages/paziente.html?id=${id}`;
          });
        });

      } catch (e) {
        showError("Errore nel caricamento agenda.");
        $("#list").innerHTML = "";
      } finally {
        $("#refreshBtn").disabled = false;
      }
    }

    // INIT
    (async () => {
      const session = await waitSession();
      if (session) {
        $("#whoami").textContent =
          `${session.nome || ""} ${session.email} • ${session.role}`;
      }

      $("#datePick").value = todayISO();
      $("#refreshBtn").addEventListener("click", () => loadAgenda($("#datePick").value));
      $("#datePick").addEventListener("change", () => loadAgenda($("#datePick").value));

      loadAgenda(todayISO());
    })();
  </script>
</body>
</html>
